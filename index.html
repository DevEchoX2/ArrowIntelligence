<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ArrowIntelligence | Neural Synthesis</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/geist@1.3.0/dist/fonts/geist.min.css" />
  <style>
    :root {
      --sidebar-bg: #fdfdfd;
      --chat-bg: #ffffff;
      --user-msg-bg: #f7f7f8;
      --border-color: #ececf1;
      --text-main: #0d0d0d;
      --text-muted: #6e6e80;
      --accent: #10a37f;
      --accent-glow: rgba(16, 163, 127, 0.1);
    }

    html.dark {
      --sidebar-bg: #000000;
      --chat-bg: #0d0d0d;
      --user-msg-bg: #1a1a1c;
      --border-color: #2d2d2d;
      --text-main: #ececec;
      --text-muted: #9a9a9a;
      --accent: #10a37f;
      --accent-glow: rgba(16, 163, 127, 0.2);
    }

    * { 
      margin: 0; padding: 0; box-sizing: border-box; 
      font-family: "Geist Sans", -apple-system, system-ui, sans-serif;
    }
    
    body { 
      background-color: var(--chat-bg); 
      color: var(--text-main); 
      height: 100dvh; 
      display: flex; 
      overflow: hidden; 
      -webkit-font-smoothing: antialiased;
    }

    .glass {
      backdrop-filter: blur(24px);
      background-color: rgba(13, 13, 13, 0.85);
      border: 1px solid var(--border-color);
    }

    .sidebar-transition { transition: width 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s; }
    
    .message-enter { animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    @keyframes slideUp { 
      from { opacity: 0; transform: translateY(24px) scale(0.98); } 
      to { opacity: 1; transform: translateY(0) scale(1); } 
    }

    .prose pre { 
      background: #0d0d0d; 
      color: #e6edf3;
      padding: 1.25rem; 
      border-radius: 0.75rem; 
      overflow-x: auto; 
      margin: 1.25rem 0; 
      font-family: "Geist Mono", monospace;
      font-size: 0.85rem;
      border: 1px solid #333;
    }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    
    .input-wrapper {
      max-width: 50rem;
      width: 100%;
      margin: 0 auto;
      background: var(--user-msg-bg);
      border-radius: 1.5rem;
      border: 1px solid var(--border-color);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .input-wrapper:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent), 0 8px 30px rgba(0,0,0,0.15);
    }

    .voice-visualizer {
      display: flex;
      align-items: center;
      gap: 3px;
      height: 20px;
    }
    .bar {
      width: 3px;
      height: 100%;
      background: var(--accent);
      border-radius: 4px;
      animation: pulse 1s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { height: 30%; }
      50% { height: 100%; }
    }

    .ai-avatar {
      width: 2rem;
      height: 2rem;
      background: linear-gradient(135deg, #10a37f, #059669);
      color: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .generated-media {
      border-radius: 1rem;
      max-width: 100%;
      height: auto;
      box-shadow: 0 12px 36px rgba(0,0,0,0.2);
      margin: 1.25rem 0;
      overflow: hidden;
      display: block;
    }

    .voice-ripple {
      animation: ripple 2.5s infinite;
    }
    @keyframes ripple {
      0% { box-shadow: 0 0 0 0 rgba(16, 163, 127, 0.4); }
      70% { box-shadow: 0 0 0 30px rgba(16, 163, 127, 0); }
      100% { box-shadow: 0 0 0 0 rgba(16, 163, 127, 0); }
    }

    .mode-switch {
      background: var(--user-msg-bg);
      border: 1px solid var(--border-color);
      padding: 3px;
      border-radius: 10px;
    }
    .mode-btn {
      padding: 4px 12px;
      border-radius: 7px;
      font-size: 11px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .mode-btn.active {
      background: var(--chat-bg);
      color: var(--text-main);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    input[type="range"] {
      accent-color: var(--accent);
    }
  </style>
</head>
<body class="bg-[var(--chat-bg)] text-[var(--text-main)]">
  <div id="root" class="w-full h-full"></div>

  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@19.0.0",
      "react-dom": "https://esm.sh/react-dom@19.0.0/client",
      "@google/genai": "https://esm.sh/@google/genai@1.34.0",
      "htm": "https://esm.sh/htm@3.1.1",
      "react-markdown": "https://esm.sh/react-markdown@9.0.1"
    }
  }
  </script>

  <script type="module">
    import React, { useState, useEffect, useRef, useCallback } from 'react';
    import { createRoot } from 'react-dom';
    import htm from 'htm';
    import { GoogleGenAI, Modality } from '@google/genai';
    import ReactMarkdown from 'react-markdown';

    const html = htm.bind(React.createElement);
    const DB_NAME = "arrow_v19_fixed";

    function decode(base64) {
      const binaryString = atob(base64);
      const len = binaryString.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      return bytes;
    }

    async function decodeAudioData(data, ctx, sampleRate, numChannels) {
      const dataInt16 = new Int16Array(data.buffer);
      const frameCount = dataInt16.length / numChannels;
      const buffer = ctx.createBuffer(numChannels, frameCount, sampleRate);
      for (let channel = 0; channel < numChannels; channel++) {
        const channelData = buffer.getChannelData(channel);
        for (let i = 0; i < frameCount; i++) {
          channelData[i] = dataInt16[i * numChannels + channel] / 32768.0;
        }
      }
      return buffer;
    }

    const Icons = {
      Plus: () => html`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>`,
      Sidebar: () => html`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M9 3v18"/></svg>`,
      Send: () => html`<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>`,
      Logo: () => html`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M7 17L17 7M17 7H7M17 7V17"/></svg>`,
      Trash: () => html`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>`,
      Mic: () => html`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>`,
      Image: () => html`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>`,
      Theme: (dark) => dark 
        ? html`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"/></svg>`
        : html`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>`,
      Settings: () => html`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>`,
      Close: () => html`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>`
    };

    const VOICES = [
      { name: 'Kore', gender: 'Female' },
      { name: 'Zephyr', gender: 'Female' },
      { name: 'Puck', gender: 'Male' },
      { name: 'Charon', gender: 'Male' },
      { name: 'Fenrir', gender: 'Male' }
    ];

    const App = () => {
      const [sessions, setSessions] = useState(() => JSON.parse(localStorage.getItem(DB_NAME) || '[]'));
      const [activeId, setActiveId] = useState(() => localStorage.getItem('arrow_active_id') || null);
      const [input, setInput] = useState('');
      const [mode, setMode] = useState('everyday');
      const [sidebarOpen, setSidebarOpen] = useState(true);
      const [isTyping, setIsTyping] = useState(false);
      const [isVoiceChat, setIsVoiceChat] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      
      // Voice Settings
      const [voiceName, setVoiceName] = useState(() => localStorage.getItem('arrow_voice_name') || 'Kore');
      const [speakingRate, setSpeakingRate] = useState(() => parseFloat(localStorage.getItem('arrow_speaking_rate')) || 1.0);
      
      const [attachedImage, setAttachedImage] = useState(null);
      const [theme, setTheme] = useState(() => localStorage.getItem('arrow_theme') || 'dark');
      
      const scrollRef = useRef(null);
      const fileInputRef = useRef(null);
      const audioCtxRef = useRef(null);
      const recognitionRef = useRef(null);

      useEffect(() => {
        localStorage.setItem(DB_NAME, JSON.stringify(sessions));
        if (activeId) localStorage.setItem('arrow_active_id', activeId);
      }, [sessions, activeId]);

      useEffect(() => {
        localStorage.setItem('arrow_theme', theme);
        document.documentElement.classList.toggle('dark', theme === 'dark');
      }, [theme]);

      useEffect(() => {
        localStorage.setItem('arrow_voice_name', voiceName);
        localStorage.setItem('arrow_speaking_rate', speakingRate.toString());
      }, [voiceName, speakingRate]);

      useEffect(() => {
        scrollRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [activeId, isTyping, sessions]);

      const createChat = useCallback(() => {
        const id = Date.now().toString();
        const newSession = { id, title: 'New chat', messages: [], mode, timestamp: Date.now() };
        setSessions(prev => [newSession, ...prev]);
        setActiveId(id);
      }, [mode]);

      const activeSession = sessions.find(s => s.id === activeId);

      const playAudio = async (base64) => {
        if (!audioCtxRef.current) {
          audioCtxRef.current = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
        }
        const ctx = audioCtxRef.current;
        const audioBuffer = await decodeAudioData(decode(base64), ctx, 24000, 1);
        const source = ctx.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(ctx.destination);
        source.start();
      };

      const handleSpeechRecognition = () => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) return;
        
        if (recognitionRef.current) {
          recognitionRef.current.stop();
          recognitionRef.current = null;
          return;
        }

        const recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.onstart = () => setIsVoiceChat(true);
        recognition.onend = () => setIsVoiceChat(false);
        recognition.onresult = (e) => {
          const transcript = e.results[0][0].transcript;
          handleAction(transcript);
        };
        recognition.start();
        recognitionRef.current = recognition;
      };

      const handleImageUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = () => setAttachedImage({
            data: reader.result.split(',')[1],
            mimeType: file.type,
            preview: reader.result
          });
          reader.readAsDataURL(file);
        }
      };

      const handleAction = async (manualText = null) => {
        const text = manualText || input;
        if (!text.trim() && !attachedImage) return;

        let targetId = activeId;
        if (!targetId) {
          targetId = Date.now().toString();
          const newSession = { id: targetId, title: text.slice(0, 30), messages: [], mode, timestamp: Date.now() };
          setSessions(prev => [newSession, ...prev]);
          setActiveId(targetId);
        }

        if (!manualText) setInput('');
        const currentImage = attachedImage;
        setAttachedImage(null);
        setIsTyping(true);

        const aiId = Date.now() + 1;
        const aiMsg = { id: aiId, role: 'assistant', content: '', isTyping: true, sources: [], images: [], videos: [] };

        setSessions(prev => prev.map(s => s.id === targetId ? {
          ...s,
          messages: [...s.messages, { id: Date.now(), role: 'user', content: text, attachment: currentImage?.preview }, aiMsg],
          title: s.messages.length === 0 ? text.slice(0, 30) : s.title
        } : s));

        try {
          const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
          const isVideo = /animate|video|motion/i.test(text);
          const isImage = /generate|create image|draw/i.test(text);
          
          let content = "";
          let images = [];
          let videos = [];
          let sources = [];

          if (isVideo) {
            let op = await ai.models.generateVideos({
              model: 'veo-3.1-fast-generate-preview',
              prompt: text,
              ...(currentImage ? { image: { imageBytes: currentImage.data, mimeType: currentImage.mimeType } } : {}),
              config: { numberOfVideos: 1, resolution: '720p', aspectRatio: '16:9' }
            });
            while (!op.done) {
              await new Promise(r => setTimeout(r, 6000));
              op = await ai.operations.getVideosOperation({operation: op});
            }
            const link = op.response?.generatedVideos?.[0]?.video?.uri;
            if (link) videos.push(`${link}&key=${process.env.API_KEY}`);
            content = "Synthesis engine: Cinematic motion finalized.";
          } else if (isImage) {
            const res = await ai.models.generateContent({
              model: 'gemini-2.5-flash-image',
              contents: { parts: [{ text }] }
            });
            if (res.candidates?.[0]?.content?.parts) {
              for (const p of res.candidates[0].content.parts) {
                if (p.inlineData) images.push(`data:${p.inlineData.mimeType};base64,${p.inlineData.data}`);
              }
            }
            content = res.text || "Synthesis engine: High-fidelity image rendered.";
          } else {
            const model = mode === 'coding' ? 'gemini-3-pro-preview' : 'gemini-3-flash-preview';
            const config = {
              systemInstruction: `ArrowIntelligence. Direct, professional, technical. Tone: High-performance.`,
              tools: mode === 'everyday' ? [{ googleSearch: {} }] : []
            };

            const hist = (sessions.find(s => s.id === targetId)?.messages || [])
              .filter(m => !m.isTyping)
              .map(m => ({ role: m.role === 'assistant' ? 'model' : 'user', parts: [{ text: m.content }] }));

            const parts = [{ text }];
            if (currentImage) parts.unshift({ inlineData: { data: currentImage.data, mimeType: currentImage.mimeType } });

            const res = await ai.models.generateContent({ model, contents: [...hist, { role: 'user', parts }], config });
            content = res.text || "Neural processing complete.";
            sources = res.candidates?.[0]?.groundingMetadata?.groundingChunks?.map(c => ({ title: c.web?.title, uri: c.web?.uri })) || [];

            if (manualText || isVoiceChat) {
              // Faster TTS: Minimize generation noise
              const ttsRes = await ai.models.generateContent({
                model: 'gemini-2.5-flash-preview-tts',
                contents: [{ parts: [{ text: content }] }],
                config: {
                  responseModalities: ['AUDIO'],
                  speechConfig: { 
                    voiceConfig: { 
                      prebuiltVoiceConfig: { 
                        voiceName: voiceName
                      } 
                    },
                    // speakingRate is often supported in modern TTS implementations
                    ...(speakingRate !== 1.0 ? { speakingRate } : {})
                  }
                }
              });
              const audioBase64 = ttsRes.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
              if (audioBase64) playAudio(audioBase64);
            }
          }

          setSessions(prev => prev.map(s => s.id === targetId ? {
            ...s,
            messages: s.messages.map(m => m.id === aiId ? { ...m, content, isTyping: false, sources, images, videos } : m)
          } : s));
        } catch (e) {
          setSessions(prev => prev.map(s => s.id === targetId ? {
            ...s,
            messages: s.messages.map(m => m.id === aiId ? { ...m, content: `Neural Error: ${e.message}`, isTyping: false } : m)
          } : s));
        } finally { setIsTyping(false); }
      };

      return html`
        <div class="flex h-full w-full bg-[var(--sidebar-bg)]">
          <aside class=${`flex flex-col border-r border-[var(--border-color)] bg-[var(--sidebar-bg)] sidebar-transition z-40 ${sidebarOpen ? 'w-64' : 'w-0 opacity-0 overflow-hidden'}`}>
            <div class="p-4">
              <button onClick=${createChat} class="flex items-center gap-3 w-full p-3 rounded-xl border border-[var(--border-color)] hover:bg-[var(--user-msg-bg)] transition-all text-sm font-semibold bg-[var(--chat-bg)]">
                <span class="text-[var(--accent)]"><${Icons.Plus} /></span>
                New thread
              </button>
            </div>
            <div class="flex-1 overflow-y-auto px-3 space-y-1 scrollbar-hide pb-8">
              ${sessions.map(s => html`
                <div key=${s.id} onClick=${() => setActiveId(s.id)} class=${`group relative flex items-center p-3 rounded-xl cursor-pointer transition-all ${activeId === s.id ? 'bg-[var(--user-msg-bg)]' : 'hover:bg-[var(--user-msg-bg)]/50'}`}>
                  <span class="text-xs truncate pr-8 font-medium ${activeId === s.id ? 'text-[var(--text-main)]' : 'text-[var(--text-muted)]'}">${s.title}</span>
                  <button onClick=${(e) => { e.stopPropagation(); setSessions(prev => prev.filter(x => x.id !== s.id)); if (activeId === s.id) setActiveId(null); }} class="absolute right-2 opacity-0 group-hover:opacity-100 p-1 text-red-500 hover:scale-110 transition-all"><${Icons.Trash} /></button>
                </div>
              `)}
            </div>
          </aside>

          <main class="flex-1 flex flex-col relative min-w-0 bg-[var(--chat-bg)]">
            <header class="h-14 flex items-center justify-between px-6 border-b border-[var(--border-color)]">
              <div class="flex items-center gap-4">
                <button onClick=${() => setSidebarOpen(!sidebarOpen)} class="p-2 hover:bg-[var(--user-msg-bg)] rounded-lg text-[var(--text-muted)]"><${Icons.Sidebar} /></button>
                <div class="mode-switch flex">
                  <button onClick=${() => setMode('everyday')} class=${`mode-btn ${mode === 'everyday' ? 'active' : 'text-[var(--text-muted)]'}`}>Everyday</button>
                  <button onClick=${() => setMode('coding')} class=${`mode-btn ${mode === 'coding' ? 'active' : 'text-[var(--text-muted)]'}`}>Coding</button>
                </div>
              </div>
              
              <div class="flex items-center gap-3">
                <button onClick=${() => setShowSettings(true)} class="p-2 hover:bg-[var(--user-msg-bg)] rounded-lg text-[var(--text-muted)] transition-colors">
                  <${Icons.Settings} />
                </button>
                <button onClick=${() => setTheme(t => t === 'light' ? 'dark' : 'light')} class="p-2 hover:bg-[var(--user-msg-bg)] rounded-lg text-[var(--text-muted)]">
                  <${Icons.Theme} dark=${theme === 'dark'} />
                </button>
              </div>
            </header>

            <div class="flex-1 overflow-y-auto scrollbar-hide">
              <div class="max-w-3xl mx-auto px-6 py-12">
                ${!activeId || (activeSession && activeSession.messages.length === 0) ? html`
                  <div class="h-full flex flex-col items-center justify-center py-20 text-center animate-in fade-in duration-700">
                    <div class="ai-avatar w-12 h-12 mb-6 shadow-xl"><${Icons.Logo} /></div>
                    <h2 class="text-3xl font-bold mb-3 tracking-tight">ArrowIntelligence</h2>
                    <p class="text-[var(--text-muted)] text-sm mb-12 opacity-50 font-medium">Neural core v19 online</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-xl">
                      <button onClick=${() => handleAction("Generate a hyper-realistic render of a futuristic server room.")} class="p-4 rounded-xl border border-[var(--border-color)] hover:bg-[var(--user-msg-bg)] text-left transition-all group">
                        <div class="text-xs font-bold uppercase mb-1 text-[var(--accent)]">Visualization</div>
                        <div class="text-xs text-[var(--text-muted)] group-hover:text-[var(--text-main)] transition-colors">Generate a high-performance neural render</div>
                      </button>
                      <button onClick=${() => handleAction("Animate a peaceful mountain valley with a flowing river.")} class="p-4 rounded-xl border border-[var(--border-color)] hover:bg-[var(--user-msg-bg)] text-left transition-all group">
                        <div class="text-xs font-bold uppercase mb-1 text-[var(--accent)]">Motion Synthesis</div>
                        <div class="text-xs text-[var(--text-muted)] group-hover:text-[var(--text-main)] transition-colors">Animate cinematic landscapes</div>
                      </button>
                    </div>
                  </div>
                ` : activeSession.messages.map(m => html`
                  <div key=${m.id} class=${`message-enter flex gap-5 mb-10 ${m.role === 'user' ? 'justify-end' : ''}`}>
                    ${m.role === 'assistant' && html`<div class="ai-avatar mt-0.5"><${Icons.Logo} /></div>`}
                    <div class=${`max-w-[85%] ${m.role === 'user' ? 'bg-[var(--user-msg-bg)] px-5 py-3 rounded-2xl' : 'flex-1'}`}>
                      ${m.attachment && html`<img src=${m.attachment} class="generated-media mb-3 h-40 w-full object-cover rounded-lg" />`}
                      <div class="prose prose-neutral dark:prose-invert max-w-none text-[15px] leading-relaxed">
                        <${ReactMarkdown}>${m.content}<//>
                        ${m.isTyping && html`<div class="flex gap-1 items-center mt-2 h-4"><div class="w-1.5 h-1.5 bg-[var(--accent)] rounded-full animate-bounce"></div><div class="w-1.5 h-1.5 bg-[var(--accent)] rounded-full animate-bounce" style=${{ animationDelay: '0.2s' }}></div><div class="w-1.5 h-1.5 bg-[var(--accent)] rounded-full animate-bounce" style=${{ animationDelay: '0.4s' }}></div></div>`}
                      </div>
                      ${m.images?.map((img, idx) => html`<img key=${idx} src=${img} class="generated-media" />`)}
                      ${m.videos?.map((vid, idx) => html`<video key=${idx} src=${vid} controls class="generated-media w-full" />`)}
                      ${m.sources?.length > 0 && html`
                        <div class="mt-6 flex flex-wrap gap-2">
                          ${m.sources.map(s => html`
                            <a key=${s.uri} href=${s.uri} target="_blank" class="px-3 py-1 rounded-lg border border-[var(--border-color)] bg-[var(--user-msg-bg)] text-[10px] font-bold text-[var(--text-muted)] hover:text-[var(--accent)] transition-colors">
                              ${s.title || 'Signal Trace'}
                            </a>
                          `)}
                        </div>
                      `}
                    </div>
                  </div>
                `)}
                <div ref=${scrollRef} />
              </div>
            </div>

            <div class="pb-8 px-6">
              <div class="input-wrapper">
                ${attachedImage && html`
                  <div class="px-6 pt-4 flex items-center">
                    <div class="relative">
                      <img src=${attachedImage.preview} class="w-12 h-12 rounded-lg object-cover" />
                      <button onClick=${() => setAttachedImage(null)} class="absolute -top-2 -right-2 bg-red-500 text-white p-1 rounded-full"><${Icons.Trash} width="10" height="10" /></button>
                    </div>
                  </div>
                `}
                <div class="flex items-center gap-2 p-3 px-4">
                  <button onClick=${() => fileInputRef.current?.click()} class="p-2 text-[var(--text-muted)] hover:text-[var(--accent)] transition-colors"><${Icons.Image} /></button>
                  <textarea rows="1" value=${input} onChange=${e => { setInput(e.target.value); e.target.style.height = 'auto'; e.target.style.height = e.target.scrollHeight + 'px'; }} onKeyDown=${e => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), handleAction())} placeholder="Message ArrowIntelligence..." class="flex-1 bg-transparent border-none outline-none resize-none py-2 text-[15px] max-h-48" />
                  <div class="flex items-center gap-1">
                    <button onClick=${handleSpeechRecognition} class="p-2.5 text-[var(--text-muted)] hover:text-[var(--accent)] transition-all">
                      <${Icons.Mic} />
                    </button>
                    <button onClick=${() => handleAction()} disabled=${(!input.trim() && !attachedImage) || isTyping} class="p-2.5 bg-[var(--text-main)] text-[var(--chat-bg)] rounded-xl disabled:opacity-10 hover:scale-105 active:scale-95 transition-all"><${Icons.Send} /></button>
                  </div>
                  <input type="file" ref=${fileInputRef} onChange=${handleImageUpload} accept="image/*" class="hidden" />
                </div>
              </div>
            </div>

            ${isVoiceChat && html`
              <div class="absolute inset-0 glass z-50 flex flex-col items-center justify-center animate-in fade-in zoom-in duration-300">
                <div class="ai-avatar w-20 h-20 mb-12 shadow-2xl voice-ripple"><${Icons.Logo} /></div>
                <div class="voice-visualizer h-12 gap-1.5 mb-10 scale-150">
                  <div class="bar"></div>
                  <div class="bar" style=${{ animationDelay: '0.1s' }}></div>
                  <div class="bar" style=${{ animationDelay: '0.2s' }}></div>
                  <div class="bar" style=${{ animationDelay: '0.3s' }}></div>
                  <div class="bar" style=${{ animationDelay: '0.4s' }}></div>
                </div>
                <p class="text-lg font-semibold mb-8 text-white tracking-tight">Listening to your pulse...</p>
                <button onClick=${() => { if(recognitionRef.current) recognitionRef.current.stop(); setIsVoiceChat(false); }} class="px-10 py-3.5 bg-red-600 text-white rounded-full font-bold hover:bg-red-700 transition-all shadow-xl">End Session</button>
              </div>
            `}

            ${showSettings && html`
              <div class="absolute inset-0 glass z-50 flex items-center justify-center p-6 animate-in fade-in duration-200">
                <div class="bg-[var(--chat-bg)] border border-[var(--border-color)] rounded-[2rem] w-full max-w-md overflow-hidden shadow-2xl">
                  <div class="px-8 py-6 border-b border-[var(--border-color)] flex items-center justify-between">
                    <h3 class="text-xl font-bold">Neural Settings</h3>
                    <button onClick=${() => setShowSettings(false)} class="p-2 hover:bg-[var(--user-msg-bg)] rounded-lg text-[var(--text-muted)] transition-colors"><${Icons.Close} /></button>
                  </div>
                  
                  <div class="p-8 space-y-8">
                    <!-- Voice Select -->
                    <div>
                      <label class="block text-xs font-bold uppercase tracking-widest text-[var(--text-muted)] mb-4">AI Voice Core</label>
                      <div class="grid grid-cols-2 gap-3">
                        ${VOICES.map(v => html`
                          <button 
                            key=${v.name}
                            onClick=${() => setVoiceName(v.name)}
                            class=${`flex flex-col items-start p-4 rounded-xl border transition-all ${voiceName === v.name ? 'border-[var(--accent)] bg-[var(--accent-glow)]' : 'border-[var(--border-color)] hover:bg-[var(--user-msg-bg)]'}`}
                          >
                            <span class="text-sm font-bold">${v.name}</span>
                            <span class="text-[10px] opacity-50 uppercase font-black">${v.gender}</span>
                          </button>
                        `)}
                      </div>
                    </div>

                    <!-- Speaking Rate -->
                    <div>
                      <div class="flex items-center justify-between mb-4">
                        <label class="block text-xs font-bold uppercase tracking-widest text-[var(--text-muted)]">Speaking Rate</label>
                        <span class="text-xs font-bold text-[var(--accent)]">${speakingRate}x</span>
                      </div>
                      <input 
                        type="range" 
                        min="0.5" 
                        max="2.0" 
                        step="0.1" 
                        value=${speakingRate} 
                        onChange=${e => setSpeakingRate(parseFloat(e.target.value))}
                        class="w-full h-2 bg-[var(--user-msg-bg)] rounded-lg appearance-none cursor-pointer"
                      />
                      <div class="flex justify-between mt-2 px-1">
                        <span class="text-[9px] font-black opacity-30 uppercase">Half</span>
                        <span class="text-[9px] font-black opacity-30 uppercase">Normal</span>
                        <span class="text-[9px] font-black opacity-30 uppercase">Double</span>
                      </div>
                    </div>
                  </div>

                  <div class="p-8 bg-[var(--user-msg-bg)] border-t border-[var(--border-color)] flex justify-end">
                    <button onClick=${() => setShowSettings(false)} class="px-8 py-3 bg-[var(--text-main)] text-[var(--chat-bg)] rounded-xl font-bold text-sm shadow-xl hover:scale-105 active:scale-95 transition-all">Save Config</button>
                  </div>
                </div>
              </div>
            `}
          </main>
        </div>
      `;
    };

    createRoot(document.getElementById('root')).render(html`<${App} />`);
  </script>
</body>
</html>
