<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ArrowIntelligence | Neural Pulse</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/geist@1.3.0/dist/fonts/geist.min.css" />
  <style>
    :root {
      --sidebar-bg: #f9f9f9;
      --chat-bg: #ffffff;
      --user-msg-bg: #f4f4f4;
      --border-color: #e5e5e5;
      --text-main: #171717;
      --text-muted: #676767;
      --accent: #10a37f;
      --code-bg: #0d1117;
      --code-header: #161b22;
    }

    html.dark {
      --sidebar-bg: #050505;
      --chat-bg: #000000;
      --user-msg-bg: #0a0a0a;
      --border-color: #111111;
      --text-main: #f5f5f5;
      --text-muted: #737373;
      --accent: #10a37f;
      --code-bg: #010409;
      --code-header: #161b22;
    }

    * { 
      margin: 0; padding: 0; box-sizing: border-box; 
      font-family: "Geist Sans", -apple-system, system-ui, sans-serif;
    }
    
    body { 
      background-color: var(--chat-bg); 
      color: var(--text-main); 
      height: 100dvh; 
      display: flex; 
      overflow: hidden; 
      -webkit-font-smoothing: antialiased;
      transition: background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .sidebar-transition { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s; }
    
    .message-enter { 
      animation: slideUp 0.4s ease-out forwards;
    }
    @keyframes slideUp { 
      from { opacity: 0; transform: translateY(12px); } 
      to { opacity: 1; transform: translateY(0); } 
    }

    .prose pre { 
      background: var(--code-bg); 
      color: #e6edf3;
      padding: 0; 
      border-radius: 0.75rem; 
      overflow: hidden; 
      margin: 1.5rem 0; 
      font-family: "Geist Mono", monospace;
      font-size: 0.85rem;
      border: 1px solid var(--border-color);
      position: relative;
    }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    
    .input-container {
      max-width: 48rem;
      width: 100%;
      margin: 0 auto;
      position: relative;
      background: var(--user-msg-bg);
      border-radius: 1.5rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid var(--border-color);
    }
    .input-container:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent), 0 12px 40px rgba(0,0,0,0.15);
    }
    html.dark .input-container:focus-within {
      box-shadow: 0 0 0 1px var(--accent), 0 12px 40px rgba(0,0,0,0.6);
    }

    .suggestion-card {
      padding: 1.25rem;
      border: 1px solid var(--border-color);
      border-radius: 1.25rem;
      background: var(--chat-bg);
      text-align: left;
      transition: all 0.25s ease;
      cursor: pointer;
    }
    .suggestion-card:hover {
      background: var(--user-msg-bg);
      transform: translateY(-4px);
      border-color: var(--text-muted);
    }

    .ai-avatar {
      width: 1.75rem;
      height: 1.75rem;
      background: var(--accent);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 0 15px rgba(16, 163, 127, 0.3);
    }

    .generated-image {
      border-radius: 1.25rem;
      max-width: 100%;
      height: auto;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      margin: 1.5rem 0;
      transition: transform 0.4s;
    }

    .neural-glow {
      background: radial-gradient(circle at center, var(--accent) 0%, transparent 70%);
      opacity: 0.05;
      pointer-events: none;
    }
  </style>
</head>
<body class="bg-[var(--chat-bg)] text-[var(--text-main)]">
  <div id="root" class="w-full h-full relative"></div>

  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@19.0.0",
      "react-dom": "https://esm.sh/react-dom@19.0.0/client",
      "@google/genai": "https://esm.sh/@google/genai@1.34.0",
      "htm": "https://esm.sh/htm@3.1.1",
      "react-markdown": "https://esm.sh/react-markdown@9.0.1"
    }
  }
  </script>

  <script type="module">
    import React, { useState, useEffect, useRef, useCallback } from 'react';
    import { createRoot } from 'react-dom';
    import htm from 'htm';
    import { GoogleGenAI } from '@google/genai';
    import ReactMarkdown from 'react-markdown';

    const html = htm.bind(React.createElement);
    const CREATOR = "E_yo";
    const DB_VERSION = "arrow_v18_persistent";

    const Icons = {
      New: () => html`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>`,
      Sidebar: () => html`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M9 3v18"/></svg>`,
      Send: () => html`<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>`,
      Arrow: () => html`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M7 17L17 7M17 7H7M17 7V17"/></svg>`,
      Trash: () => html`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>`,
      Moon: () => html`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>`,
      Sun: () => html`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>`,
      Plug: () => html`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>`
    };

    const SUGGESTIONS = {
      everyday: [
        { title: "Condense Intelligence", desc: "Synthesize large data points.", prompt: "Summarize this technical concept for a non-expert audience: " },
        { title: "Neural Art", desc: "Symmetry and form.", prompt: "Create a minimalist digital artwork representing the concept of 'Flow State'." },
        { title: "Trend Sync", desc: "Real-time market signals.", prompt: "Search for the top 3 emerging tech trends of the current quarter." }
      ],
      coding: [
        { title: "Logic Refiner", desc: "Clean code transformation.", prompt: "Refactor the following code for better readability and performance: " },
        { title: "Bug Trace", desc: "Error signal isolation.", prompt: "Find the root cause of this memory leak: " },
        { title: "System Draft", desc: "Blueprint creation.", prompt: "Draft a system architecture for a real-time multiplayer collaborative canvas." }
      ]
    };

    const App = () => {
      const [sessions, setSessions] = useState(() => JSON.parse(localStorage.getItem(DB_VERSION) || '[]'));
      const [activeId, setActiveId] = useState(() => localStorage.getItem('arrow_active_id') || null);
      const [input, setInput] = useState('');
      const [mode, setMode] = useState('everyday');
      const [sidebarOpen, setSidebarOpen] = useState(true);
      const [isTyping, setIsTyping] = useState(false);
      const [theme, setTheme] = useState(() => localStorage.getItem('arrow_theme') || 'dark');
      const [isInitialized, setIsInitialized] = useState(false);
      
      const scrollRef = useRef(null);

      // --- Functions defined at top of component to avoid ReferenceErrors ---
      const createChat = useCallback(() => {
        const id = Date.now().toString();
        setSessions(prev => [{ id, title: 'New Signal', messages: [], mode }, ...prev]);
        setActiveId(id);
      }, [mode]);

      const handleConnect = useCallback(async () => {
        if (window.aistudio) {
          await window.aistudio.openSelectKey();
          setIsInitialized(true); 
        } else {
          alert("Neural Interface Error: Please use a Gemini-compatible environment or provide API_KEY.");
        }
      }, []);

      const activeSession = sessions.find(s => s.id === activeId);

      useEffect(() => {
        const checkConnection = async () => {
          if (process.env.API_KEY) {
            setIsInitialized(true);
            return;
          }
          if (window.aistudio) {
            const hasKey = await window.aistudio.hasSelectedApiKey();
            if (hasKey) setIsInitialized(true);
          }
        };
        checkConnection();
      }, []);

      useEffect(() => {
        localStorage.setItem(DB_VERSION, JSON.stringify(sessions));
        if (activeId) localStorage.setItem('arrow_active_id', activeId);
      }, [sessions, activeId]);

      useEffect(() => {
        localStorage.setItem('arrow_theme', theme);
        document.documentElement.classList.toggle('dark', theme === 'dark');
      }, [theme]);

      useEffect(() => {
        scrollRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [activeSession?.messages, isTyping]);

      const handleAction = async (manualText = null, isRegen = false) => {
        const text = manualText || input;
        if (!text.trim() && !isRegen) return;

        let targetId = activeId;
        if (!targetId) {
          targetId = Date.now().toString();
          setSessions(prev => [{ id: targetId, title: text.slice(0, 30), messages: [], mode }, ...prev]);
          setActiveId(targetId);
        }

        if (!isRegen) setInput('');
        setIsTyping(true);

        const aiId = Date.now() + 1;
        const aiMsg = { id: aiId, role: 'assistant', content: '', isTyping: true, sources: [], images: [] };

        setSessions(prev => prev.map(s => s.id === targetId ? {
          ...s,
          messages: isRegen ? [...s.messages, aiMsg] : [...s.messages, { id: Date.now(), role: 'user', content: text }, aiMsg],
          title: s.messages.length === 0 ? text.slice(0, 30) : s.title
        } : s));

        try {
          const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
          const isImageRequest = /generate|create|draw|make an image|picture/i.test(text);
          
          let model = mode === 'coding' ? 'gemini-3-pro-preview' : 'gemini-3-flash-preview';
          let config = { systemInstruction: `You are ArrowIntelligence. Current Mode: ${mode}. Precise, technical, and high-performance.` };

          if (isImageRequest) {
            model = 'gemini-2.5-flash-image';
            config.imageConfig = { aspectRatio: "1:1" };
          } else if (mode === 'coding') {
            config.thinkingConfig = { thinkingBudget: 16000 };
          } else {
            config.tools = [{ googleSearch: {} }];
          }

          const sessionObj = sessions.find(s => s.id === targetId) || { messages: [] };
          const history = sessionObj.messages.filter(m => !m.isTyping).map(m => ({
            role: m.role === 'assistant' ? 'model' : 'user',
            parts: [{ text: m.content }]
          }));

          const prompt = isRegen ? sessionObj.messages.slice().reverse().find(m => m.role === 'user').content : text;

          const res = await ai.models.generateContent({
            model,
            contents: isImageRequest ? { parts: [{ text: prompt }] } : [...history, { role: 'user', parts: [{ text: prompt }] }],
            config
          });

          let content = res.text || "";
          let images = [];
          if (res.candidates?.[0]?.content?.parts) {
            for (const part of res.candidates[0].content.parts) {
              if (part.inlineData) images.push(`data:${part.inlineData.mimeType};base64,${part.inlineData.data}`);
            }
          }

          const sources = res.candidates?.[0]?.groundingMetadata?.groundingChunks?.map(c => ({
            title: c.web?.title || 'Data Stream',
            uri: c.web?.uri
          })) || [];

          setSessions(prev => prev.map(s => s.id === targetId ? {
            ...s,
            messages: s.messages.map(m => m.id === aiId ? { ...m, content: content || "Sync finalized.", isTyping: false, sources, images } : m)
          } : s));
        } catch (e) {
          if (e.message?.includes("Requested entity was not found")) setIsInitialized(false);
          setSessions(prev => prev.map(s => s.id === targetId ? {
            ...s,
            messages: s.messages.map(m => m.id === aiId ? { ...m, content: `Neural Exception: ${e.message}`, isTyping: false } : m)
          } : s));
        } finally { setIsTyping(false); }
      };

      if (!isInitialized) {
        return html`
          <div class="h-full w-full flex items-center justify-center p-8 bg-[var(--chat-bg)] relative overflow-hidden">
            <div class="absolute inset-0 neural-glow"></div>
            <div class="max-w-md w-full text-center space-y-10 animate-in fade-in zoom-in duration-700 relative z-10">
              <div class="w-24 h-24 bg-gradient-to-br from-[var(--accent)] to-[#0c8a6a] text-white rounded-[2.5rem] flex items-center justify-center mx-auto shadow-[0_20px_60px_rgba(16,163,127,0.4)] rotate-3 hover:rotate-0 transition-transform duration-500">
                <${Icons.Arrow} width="48" height="48" />
              </div>
              <div class="space-y-3">
                <h1 class="text-4xl font-black tracking-tightest">ArrowIntelligence</h1>
                <p class="text-[var(--text-muted)] text-sm font-medium opacity-60 px-8 leading-relaxed">
                  System restricted. <br/>Link your neural API core to continue.
                </p>
              </div>
              <button onClick=${handleConnect} class="w-full py-5 bg-[var(--text-main)] text-[var(--chat-bg)] rounded-3xl font-black uppercase tracking-[0.2em] shadow-2xl hover:scale-[1.03] active:scale-95 transition-all flex items-center justify-center gap-4">
                <${Icons.Plug} /> Link Neural Core
              </button>
              <div class="pt-8 border-t border-[var(--border-color)]/30">
                <a href="https://ai.google.dev/gemini-api/docs/billing" target="_blank" class="text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)] hover:text-[var(--accent)] transition-colors">
                  Setup & Billing Support
                </a>
              </div>
            </div>
          </div>
        `;
      }

      return html`
        <div class="flex h-full w-full bg-[var(--sidebar-bg)] animate-in fade-in duration-500">
          <aside class=${`flex flex-col border-r border-[var(--border-color)] bg-[var(--sidebar-bg)] sidebar-transition z-40 ${sidebarOpen ? 'w-80' : 'w-0 opacity-0 overflow-hidden'}`}>
            <div class="p-6">
              <button onClick=${createChat} class="flex items-center gap-4 w-full p-4 rounded-2xl border border-[var(--border-color)] hover:bg-[var(--user-msg-bg)] transition-all text-sm font-bold shadow-sm bg-[var(--chat-bg)]">
                <div class="text-[var(--accent)]"><${Icons.New} /></div>
                New Signal
              </button>
            </div>
            
            <div class="flex-1 overflow-y-auto px-5 space-y-2 scrollbar-hide py-4">
              <div class="text-[10px] font-black uppercase tracking-[0.3em] text-[var(--text-muted)] opacity-20 px-3 mb-6">Archive</div>
              ${sessions.map(s => html`
                <div key=${s.id} onClick=${() => setActiveId(s.id)} class=${`group relative flex items-center p-4 rounded-xl cursor-pointer transition-all ${activeId === s.id ? 'bg-[var(--user-msg-bg)] shadow-inner ring-1 ring-[var(--border-color)]' : 'hover:bg-[var(--user-msg-bg)]/50'}`}>
                  <span class="text-[13px] truncate pr-10 font-medium ${activeId === s.id ? 'text-[var(--text-main)]' : 'text-[var(--text-muted)]'}">${s.title}</span>
                  <button onClick=${(e) => { e.stopPropagation(); setSessions(prev => prev.filter(x => x.id !== s.id)); if (activeId === s.id) setActiveId(null); }} class="absolute right-4 opacity-0 group-hover:opacity-100 p-2 text-red-500/50 hover:text-red-500 transition-all"><${Icons.Trash} /></button>
                </div>
              `)}
            </div>

            <div class="p-8 border-t border-[var(--border-color)]">
              <div class="flex items-center justify-between opacity-30 text-[9px] font-black uppercase tracking-[0.3em]">
                <span>Arrow V.18 â€¢ ${CREATOR}</span>
                <span class="text-green-500 flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Pulse</span>
              </div>
            </div>
          </aside>

          <main class="flex-1 flex flex-col relative min-w-0 bg-[var(--chat-bg)]">
            <header class="h-16 flex items-center justify-between px-8 z-30 border-b border-[var(--border-color)]/30">
              <div class="flex items-center gap-4">
                <button onClick=${() => setSidebarOpen(!sidebarOpen)} class="p-3 hover:bg-[var(--user-msg-bg)] rounded-2xl text-[var(--text-muted)] transition-colors"><${Icons.Sidebar} /></button>
                <button onClick=${() => setTheme(t => t === 'light' ? 'dark' : 'light')} class="p-3 hover:bg-[var(--user-msg-bg)] rounded-2xl text-[var(--text-muted)] transition-colors">
                  ${theme === 'light' ? html`<${Icons.Moon} />` : html`<${Icons.Sun} />`}
                </button>
              </div>
              
              <div class="flex bg-[var(--user-msg-bg)] p-1 rounded-2xl border border-[var(--border-color)]">
                <button onClick=${() => setMode('everyday')} class=${`px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-[0.2em] transition-all ${mode === 'everyday' ? 'bg-[var(--chat-bg)] shadow-sm text-[var(--text-main)]' : 'opacity-40 text-[var(--text-muted)] hover:opacity-100'}`}>Everyday</button>
                <button onClick=${() => setMode('coding')} class=${`px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-[0.2em] transition-all ${mode === 'coding' ? 'bg-[var(--chat-bg)] shadow-sm text-[var(--text-main)]' : 'opacity-40 text-[var(--text-muted)] hover:opacity-100'}`}>Coding</button>
              </div>
              
              <div class="w-10"></div>
            </header>

            <div class="flex-1 overflow-y-auto scrollbar-hide">
              <div class="max-w-3xl mx-auto px-10 py-16">
                ${!activeId || (activeSession && activeSession.messages.length === 0) ? html`
                  <div class="h-full flex flex-col items-center justify-center py-10 text-center">
                    <div class="w-20 h-20 bg-[var(--accent)] text-white rounded-[2rem] flex items-center justify-center mb-10 shadow-[0_15px_40px_rgba(16,163,127,0.3)]">
                      <${Icons.Arrow} width="40" height="40" />
                    </div>
                    <h2 class="text-4xl font-black mb-4 tracking-tightest">ArrowIntelligence</h2>
                    <p class="text-[var(--text-muted)] text-sm max-w-sm mb-16 leading-relaxed opacity-60">Neural bridge active. Mode: ${mode}.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-4xl px-4">
                      ${SUGGESTIONS[mode].map(s => html`
                        <button key=${s.title} onClick=${() => { setInput(s.prompt); handleAction(s.prompt); }} class="suggestion-card group">
                          <h4 class="font-bold text-[12px] mb-2 uppercase tracking-widest group-hover:text-[var(--accent)] transition-colors">${s.title}</h4>
                          <p class="text-[11px] text-[var(--text-muted)] leading-relaxed opacity-80">${s.desc}</p>
                        </button>
                      `)}
                    </div>
                  </div>
                ` : activeSession.messages.map(m => html`
                  <div key=${m.id} class=${`message-enter flex gap-8 mb-16 group ${m.role === 'user' ? 'justify-end' : ''}`}>
                    ${m.role === 'assistant' && html`<div class="ai-avatar mt-1"><${Icons.Arrow} /></div>`}
                    <div class=${`max-w-[92%] ${m.role === 'user' ? 'bg-[var(--user-msg-bg)] px-8 py-6 rounded-[2.5rem] border border-[var(--border-color)] shadow-sm' : 'flex-1 pt-1'}`}>
                      <div class="prose prose-neutral dark:prose-invert max-w-none text-[15px] leading-relaxed">
                        <${ReactMarkdown}>${m.content}<//>
                        ${m.isTyping && html`<span class="inline-block w-1.5 h-4 bg-[var(--accent)] animate-pulse ml-1 align-middle rounded-full"></span>`}
                      </div>
                      ${m.images?.map((img, idx) => html`<img key=${idx} src=${img} class="generated-image" alt="Synthesis" />`)}
                      ${m.sources?.length > 0 && html`
                        <div class="mt-8 flex flex-wrap gap-3 pt-6 border-t border-[var(--border-color)]/20">
                          ${m.sources.map(s => html`
                            <a key=${s.uri} href=${s.uri} target="_blank" class="px-4 py-2 rounded-xl border border-[var(--border-color)] bg-[var(--user-msg-bg)] text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)] hover:text-[var(--accent)] transition-all truncate max-w-[180px]">
                              ${s.title}
                            </a>
                          `)}
                        </div>
                      `}
                    </div>
                  </div>
                `)}
                <div ref=${scrollRef} />
              </div>
            </div>

            <div class="pb-12 px-10">
              <div class="input-container">
                <div class="flex items-end gap-3 p-5 pl-7">
                  <textarea rows="1" value=${input} onChange=${e => setInput(e.target.value)} onKeyDown=${e => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), handleAction())} placeholder="Signal interface..." class="flex-1 bg-transparent border-none outline-none resize-none py-2 text-[15px] placeholder:text-[var(--text-muted)] placeholder:opacity-30" />
                  <button onClick=${() => handleAction()} disabled=${!input.trim() || isTyping} class="p-4 bg-[var(--text-main)] text-[var(--chat-bg)] rounded-2xl disabled:opacity-5 hover:scale-105 active:scale-95 transition-all shadow-xl"><${Icons.Send} /></button>
                </div>
              </div>
            </div>
          </main>
        </div>
      `;
    };

    createRoot(document.getElementById('root')).render(html`<${App} />`);
  </script>
</body>
</html>
